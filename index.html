<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prius Fuel Efficiency Tracker</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .data-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }
        
        .content {
            padding: 30px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            border-left: 5px solid #2ecc71;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #2c3e50;
            border-bottom: 3px solid #2ecc71;
            padding-bottom: 10px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .input-form {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .suggestion-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .suggestion-item:hover {
            background: #f8f9fa;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .suggestion-address {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 2px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #2ecc71;
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }
        
        .data-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .data-table tr:nth-child(even) {
            background: #fdfdfd;
        }
        
        .data-table tr:nth-child(even):hover {
            background: #f8f9fa;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }
        
        .stats-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #7f8c8d;
        }
        
        .stat-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .no-data {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 40px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .data-controls {
                position: relative;
                top: auto;
                right: auto;
                justify-content: center;
                margin-top: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="data-controls">
                <button class="control-btn" onclick="exportData()">📊 Export Data</button>
                <button class="control-btn" onclick="importData()">📥 Import Data</button>
                <button class="control-btn" onclick="clearAllData()">🗑️ Clear All</button>
            </div>
            <h1>🚗 Prius Fuel Efficiency Tracker</h1>
            <p>Track your fuel efficiency, costs, and driving patterns</p>
        </div>
        
        <div class="content">
            <!-- Dashboard -->
            <div class="section">
                <h2>📊 Dashboard</h2>
                <div class="dashboard">
                    <div class="metric-card">
                        <div class="metric-value" id="avgMPG">--</div>
                        <div class="metric-label">Average MPG</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="totalMiles">--</div>
                        <div class="metric-label">Total Miles</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="totalSpent">$--</div>
                        <div class="metric-label">Total Spent</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgCostPerMile">$--</div>
                        <div class="metric-label">Cost per Mile</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="totalFillUps">--</div>
                        <div class="metric-label">Fill-ups</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgRange">--</div>
                        <div class="metric-label">Avg Range (mi)</div>
                    </div>
                </div>
            </div>
            
            <!-- Input Form -->
            <div class="section">
                <h2>⛽ Add New Fill-up</h2>
                <div class="input-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fillupDate">Date *</label>
                            <input type="date" id="fillupDate" required>
                        </div>
                        <div class="form-group">
                            <label for="odometer">Odometer Reading (miles) *</label>
                            <input type="number" id="odometer" placeholder="e.g., 359.5" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="gallons">Gallons Purchased *</label>
                            <input type="number" id="gallons" placeholder="e.g., 8.235" step="0.001" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="octaneRating">Octane Rating *</label>
                            <select id="octaneRating" required onchange="updatePricePerGallon()">
                                <option value="">Select Octane</option>
                                <option value="87">87 (Regular)</option>
                                <option value="89">89 (Mid-grade)</option>
                                <option value="91">91 (Premium)</option>
                                <option value="93">93 (Premium)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pricePerGallon">Price per Gallon ($) *</label>
                            <input type="number" id="pricePerGallon" placeholder="e.g., 4.799" step="0.001" required onchange="updateTotalCost()">
                        </div>
                        <div class="form-group">
                            <label for="totalCost">Total Cost ($) *</label>
                            <input type="number" id="totalCost" placeholder="e.g., 39.52" step="0.01" required onchange="updatePricePerGallon()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="predictedRange">Predicted Range (miles)</label>
                            <input type="number" id="predictedRange" placeholder="e.g., 528" step="1">
                        </div>
                        <div class="form-group">
                            <label for="gasStation">Gas Station *</label>
                            <input type="text" id="gasStation" placeholder="Search for gas station..." required>
                            <div id="gasStationSuggestions" class="suggestions-dropdown"></div>
                        </div>
                        <div class="form-group">
                            <label for="stationAddress">Station Address</label>
                            <input type="text" id="stationAddress" placeholder="Auto-filled from selection" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="notes">Notes</label>
                            <input type="text" id="notes" placeholder="Optional notes">
                        </div>
                    </div>
                    <button class="btn" onclick="addFillUp()">Add Fill-up Record</button>
                </div>
            </div>
            
            <!-- Statistics -->
            <div class="section">
                <h2>📈 Detailed Statistics</h2>
                <div class="stats-grid">
                    <div class="stats-card">
                        <h3>🏆 Best Performance</h3>
                        <div class="stat-item">
                            <span class="stat-label">Best MPG:</span>
                            <span class="stat-value" id="bestMPG">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Lowest Cost/Mile:</span>
                            <span class="stat-value" id="bestCostPerMile">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Longest Range:</span>
                            <span class="stat-value" id="bestRange">--</span>
                        </div>
                    </div>
                    
                    <div class="stats-card">
                        <h3>⛽ Fuel Details</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Gallons:</span>
                            <span class="stat-value" id="totalGallons">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Price/Gallon:</span>
                            <span class="stat-value" id="avgPricePerGallon">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Most Used Octane:</span>
                            <span class="stat-value" id="mostUsedOctane">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data Table -->
            <div class="section">
                <h2>📋 Fill-up History 
                    <span style="font-size: 0.7em; font-weight: normal; color: #7f8c8d;">
                        (<span id="recordCount">0</span> records)
                    </span>
                </h2>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Odometer</th>
                                <th>Miles</th>
                                <th>Gallons</th>
                                <th>MPG</th>
                                <th>$/Gal</th>
                                <th>Total Cost</th>
                                <th>Octane</th>
                                <th>Range</th>
                                <th>$/Mile</th>
                                <th>Gas Station</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr>
                                <td colspan="12" class="no-data">No fill-up records yet. Add your first fill-up above!</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="fileInput" style="display: none;" accept=".json" onchange="handleFileImport(event)">

    <!-- Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places&callback=initMap"></script>

    <script>
        let fillUpData = [];
        let map;
        let service;
        let autocompleteService;
        let placesService;
        let selectedPlace = null;
        
        // Initialize Google Maps
        function initMap() {
            // Initialize map (hidden, just for places service)
            map = new google.maps.Map(document.createElement('div'));
            service = new google.maps.places.PlacesService(map);
            autocompleteService = new google.maps.places.AutocompleteService();
        }
        
        // Set today's date as default
        document.getElementById('fillupDate').valueAsDate = new Date();
        
        // Load data from localStorage on page load
        window.onload = function() {
            loadData();
            updateDisplay();
            setupGasStationSearch();
        };
        
        function setupGasStationSearch() {
            const gasStationInput = document.getElementById('gasStation');
            const suggestionsDiv = document.getElementById('gasStationSuggestions');
            let searchTimeout;
            
            gasStationInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (query.length < 3) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                // Debounce search
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchGasStations(query);
                }, 300);
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!gasStationInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }
        
        function searchGasStations(query) {
            if (!autocompleteService) {
                console.warn('Google Maps not loaded yet');
                return;
            }
            
            const request = {
                input: query + ' gas station',
                types: ['gas_station'],
                componentRestrictions: { country: 'us' }
            };
            
            autocompleteService.getPlacePredictions(request, (predictions, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                    displayGasStationSuggestions(predictions);
                } else {
                    document.getElementById('gasStationSuggestions').style.display = 'none';
                }
            });
        }
        
        function displayGasStationSuggestions(predictions) {
            const suggestionsDiv = document.getElementById('gasStationSuggestions');
            suggestionsDiv.innerHTML = '';
            
            predictions.slice(0, 5).forEach(prediction => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `
                    <div class="suggestion-name">${prediction.structured_formatting.main_text}</div>
                    <div class="suggestion-address">${prediction.structured_formatting.secondary_text}</div>
                `;
                
                item.addEventListener('click', () => {
                    selectGasStation(prediction);
                });
                
                suggestionsDiv.appendChild(item);
            });
            
            suggestionsDiv.style.display = 'block';
        }
        
        function selectGasStation(prediction) {
            document.getElementById('gasStation').value = prediction.structured_formatting.main_text;
            document.getElementById('stationAddress').value = prediction.structured_formatting.secondary_text || '';
            document.getElementById('gasStationSuggestions').style.display = 'none';
            
            selectedPlace = {
                name: prediction.structured_formatting.main_text,
                address: prediction.structured_formatting.secondary_text || '',
                placeId: prediction.place_id
            };
        }
        
        function updatePricePerGallon() {
            const gallons = parseFloat(document.getElementById('gallons').value);
            const totalCost = parseFloat(document.getElementById('totalCost').value);
            
            if (gallons && totalCost) {
                const pricePerGallon = totalCost / gallons;
                document.getElementById('pricePerGallon').value = pricePerGallon.toFixed(3);
            }
        }
        
        function updateTotalCost() {
            const gallons = parseFloat(document.getElementById('gallons').value);
            const pricePerGallon = parseFloat(document.getElementById('pricePerGallon').value);
            
            if (gallons && pricePerGallon) {
                const totalCost = gallons * pricePerGallon;
                document.getElementById('totalCost').value = totalCost.toFixed(2);
            }
        }
        
        function saveData() {
            try {
                const dataToSave = {
                    fillUpData: fillUpData,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('priusFuelData', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Error saving data. Your browser storage might be full.');
            }
        }
        
        function loadData() {
            try {
                const savedData = localStorage.getItem('priusFuelData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    fillUpData = parsed.fillUpData || [];
                }
            } catch (error) {
                console.error('Error loading data:', error);
                fillUpData = [];
            }
        }
        
        function addFillUp() {
            const date = document.getElementById('fillupDate').value;
            const odometer = parseFloat(document.getElementById('odometer').value);
            const gallons = parseFloat(document.getElementById('gallons').value);
            const pricePerGallon = parseFloat(document.getElementById('pricePerGallon').value);
            const totalCost = parseFloat(document.getElementById('totalCost').value);
            const octaneRating = document.getElementById('octaneRating').value;
            const predictedRange = parseInt(document.getElementById('predictedRange').value) || null;
            const gasStation = document.getElementById('gasStation').value.trim();
            const stationAddress = document.getElementById('stationAddress').value.trim();
            const notes = document.getElementById('notes').value.trim();
            
            if (!date || !odometer || !gallons || !pricePerGallon || !totalCost || !octaneRating || !gasStation) {
                alert('Please fill in all required fields (marked with *)');
                return;
            }
            
            // Verify price calculation is reasonable
            const calculatedTotal = gallons * pricePerGallon;
            if (Math.abs(calculatedTotal - totalCost) > 0.05) {
                if (!confirm(`Price calculation seems off. Calculated: ${calculatedTotal.toFixed(2)}, Entered: ${totalCost.toFixed(2)}. Continue anyway?`)) {
                    return;
                }
            }
            
            // Check for duplicate odometer readings
            if (fillUpData.some(f => Math.abs(f.odometer - odometer) < 0.1)) {
                if (!confirm('Warning: You have a very similar odometer reading already recorded. Continue anyway?')) {
                    return;
                }
            }
            
            let milesDriven = null;
            let mpg = null;
            let costPerMile = null;
            
            if (fillUpData.length > 0) {
                // Find the most recent previous fill-up
                const sortedData = [...fillUpData].sort((a, b) => a.odometer - b.odometer);
                const lastEntry = sortedData[sortedData.length - 1];
                
                if (odometer > lastEntry.odometer) {
                    milesDriven = odometer - lastEntry.odometer;
                    mpg = milesDriven / gallons;
                    costPerMile = totalCost / milesDriven;
                }
            }
            
            const fillUp = {
                id: Date.now(), // Simple ID for deletion
                date,
                odometer,
                milesDriven,
                gallons,
                mpg,
                pricePerGallon,
                totalCost,
                octaneRating,
                predictedRange,
                costPerMile,
                gasStation,
                stationAddress,
                notes,
                placeId: selectedPlace ? selectedPlace.placeId : null
            };
            
            fillUpData.push(fillUp);
            saveData();
            updateDisplay();
            clearForm();
            
            // Show success message
            showAlert('Fill-up record added successfully!', 'success');
        }
        
        function deleteFillUp(id) {
            if (confirm('Are you sure you want to delete this fill-up record?')) {
                fillUpData = fillUpData.filter(f => f.id !== id);
                saveData();
                updateDisplay();
                showAlert('Fill-up record deleted.', 'info');
            }
        }
        
        function updateDisplay() {
            updateTable();
            updateDashboard();
            updateStatistics();
        }
        
        function updateTable() {
            const tbody = document.getElementById('dataTableBody');
            const recordCount = document.getElementById('recordCount');
            
            recordCount.textContent = fillUpData.length;
            
            if (fillUpData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="no-data">No fill-up records yet. Add your first fill-up above!</td></tr>';
                return;
            }
            
            // Sort by date (newest first)
            const sortedData = [...fillUpData].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = '';
            
            sortedData.forEach(fillUp => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(fillUp.date).toLocaleDateString()}</td>
                    <td>${fillUp.odometer.toFixed(1)}</td>
                    <td>${fillUp.milesDriven !== null ? fillUp.milesDriven.toFixed(1) : '--'}</td>
                    <td>${fillUp.gallons.toFixed(3)}</td>
                    <td>${fillUp.mpg !== null ? fillUp.mpg.toFixed(1) : '--'}</td>
                    <td>${fillUp.pricePerGallon.toFixed(3)}</td>
                    <td>${fillUp.totalCost.toFixed(2)}</td>
                    <td>${fillUp.octaneRating}</td>
                    <td>${fillUp.predictedRange || '--'}</td>
                    <td>${fillUp.costPerMile !== null ? '
            });
        }
        
        function updateDashboard() {
            if (fillUpData.length === 0) {
                document.getElementById('avgMPG').textContent = '--';
                document.getElementById('totalMiles').textContent = '--';
                document.getElementById('totalSpent').textContent = '$--';
                document.getElementById('avgCostPerMile').textContent = '$--';
                document.getElementById('totalFillUps').textContent = '0';
                document.getElementById('avgRange').textContent = '--';
                return;
            }
            
            // Calculate metrics
            const validMPG = fillUpData.filter(f => f.mpg !== null && f.mpg > 0).map(f => f.mpg);
            const avgMPG = validMPG.length > 0 ? validMPG.reduce((a, b) => a + b, 0) / validMPG.length : 0;
            
            const sortedByOdometer = [...fillUpData].sort((a, b) => a.odometer - b.odometer);
            const totalMiles = sortedByOdometer.length > 1 ? 
                sortedByOdometer[sortedByOdometer.length - 1].odometer - sortedByOdometer[0].odometer : 0;
            
            const totalSpent = fillUpData.reduce((sum, f) => sum + f.totalCost, 0);
            
            const validCostPerMile = fillUpData.filter(f => f.costPerMile !== null && f.costPerMile > 0).map(f => f.costPerMile);
            const avgCostPerMile = validCostPerMile.length > 0 ? 
                validCostPerMile.reduce((a, b) => a + b, 0) / validCostPerMile.length : 0;
            
            const validRange = fillUpData.filter(f => f.predictedRange && f.predictedRange > 0).map(f => f.predictedRange);
            const avgRange = validRange.length > 0 ? 
                validRange.reduce((a, b) => a + b, 0) / validRange.length : 0;
            
            // Update dashboard
            document.getElementById('avgMPG').textContent = avgMPG > 0 ? avgMPG.toFixed(1) : '--';
            document.getElementById('totalMiles').textContent = totalMiles > 0 ? totalMiles.toLocaleString() : '--';
            document.getElementById('totalSpent').textContent = '$' + totalSpent.toFixed(2);
            document.getElementById('avgCostPerMile').textContent = avgCostPerMile > 0 ? '$' + avgCostPerMile.toFixed(3) : '--';
            document.getElementById('totalFillUps').textContent = fillUpData.length;
            document.getElementById('avgRange').textContent = avgRange > 0 ? Math.round(avgRange) : '--';
        }
        
        function updateStatistics() {
            if (fillUpData.length === 0) {
                document.getElementById('bestMPG').textContent = '--';
                document.getElementById('bestCostPerMile').textContent = '--';
                document.getElementById('bestRange').textContent = '--';
                document.getElementById('totalGallons').textContent = '--';
                document.getElementById('avgPricePerGallon').textContent = '--';
                document.getElementById('mostUsedOctane').textContent = '--';
                return;
            }
            
            // Best performance
            const validMPG = fillUpData.filter(f => f.mpg !== null && f.mpg > 0);
            const bestMPG = validMPG.length > 0 ? Math.max(...validMPG.map(f => f.mpg)) : 0;
            
            const validCostPerMile = fillUpData.filter(f => f.costPerMile !== null && f.costPerMile > 0);
            const bestCostPerMile = validCostPerMile.length > 0 ? Math.min(...validCostPerMile.map(f => f.costPerMile)) : 0;
            
            const validRange = fillUpData.filter(f => f.predictedRange && f.predictedRange > 0);
            const bestRange = validRange.length > 0 ? Math.max(...validRange.map(f => f.predictedRange)) : 0;
            
            // Fuel details
            const totalGallons = fillUpData.reduce((sum, f) => sum + f.gallons, 0);
            const avgPricePerGallon = fillUpData.reduce((sum, f) => sum + f.pricePerGallon, 0) / fillUpData.length;
            
            // Most used octane
            const octaneCounts = {};
            fillUpData.forEach(f => {
                octaneCounts[f.octaneRating] = (octaneCounts[f.octaneRating] || 0) + 1;
            });
            const mostUsedOctane = Object.keys(octaneCounts).reduce((a, b) => 
                octaneCounts[a] > octaneCounts[b] ? a : b, '');
            
            // Update statistics
            document.getElementById('bestMPG').textContent = bestMPG > 0 ? bestMPG.toFixed(1) : '--';
            document.getElementById('bestCostPerMile').textContent = bestCostPerMile > 0 ? '$' + bestCostPerMile.toFixed(3) : '--';
            document.getElementById('bestRange').textContent = bestRange > 0 ? bestRange + ' mi' : '--';
            document.getElementById('totalGallons').textContent = totalGallons.toFixed(1);
            document.getElementById('avgPricePerGallon').textContent = '$' + avgPricePerGallon.toFixed(3);
            document.getElementById('mostUsedOctane').textContent = mostUsedOctane ? mostUsedOctane + ' octane' : '--';
        }
        
        function clearForm() {
            document.getElementById('fillupDate').valueAsDate = new Date();
            document.getElementById('odometer').value = '';
            document.getElementById('gallons').value = '';
            document.getElementById('pricePerGallon').value = '';
            document.getElementById('totalCost').value = '';
            document.getElementById('octaneRating').value = '';
            document.getElementById('predictedRange').value = '';
            document.getElementById('gasStation').value = '';
            document.getElementById('stationAddress').value = '';
            document.getElementById('notes').value = '';
            selectedPlace = null;
        }
        
        function exportData() {
            if (fillUpData.length === 0) {
                alert('No data to export!');
                return;
            }
            
            const exportData = {
                fillUpData: fillUpData,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `prius-fuel-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAlert('Data exported successfully!', 'success');
        }
        
        function importData() {
            document.getElementById('fileInput').click();
        }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.fillUpData && Array.isArray(importedData.fillUpData)) {
                        if (fillUpData.length > 0) {
                            if (!confirm('This will replace all existing data. Are you sure?')) {
                                return;
                            }
                        }
                        
                        fillUpData = importedData.fillUpData;
                        saveData();
                        updateDisplay();
                        showAlert(`Successfully imported ${fillUpData.length} records!`, 'success');
                    } else {
                        throw new Error('Invalid file format');
                    }
                } catch (error) {
                    alert('Error importing file. Please make sure it\'s a valid Prius Fuel Tracker export file.');
                }
            };
            reader.readAsText(file);
            
            // Reset the file input
            event.target.value = '';
        }
        
        function clearAllData() {
            if (fillUpData.length === 0) {
                alert('No data to clear!');
                return;
            }
            
            if (confirm('Are you sure you want to delete ALL fill-up records? This cannot be undone!')) {
                if (confirm('Really sure? This will permanently delete all your fuel tracking data!')) {
                    fillUpData = [];
                    saveData();
                    updateDisplay();
                    showAlert('All data cleared.', 'info');
                }
            }
        }
        
        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(alert, content.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // Auto-save every 30 seconds as backup
        setInterval(() => {
            if (fillUpData.length > 0) {
                saveData();
            }
        }, 30000);
    </script>
</body>
</html> + fillUp.costPerMile.toFixed(3) : '--'}</td>
                    <td title="${fillUp.stationAddress || ''}">${fillUp.gasStation || fillUp.location || '--'}</td>
                    <td><button class="delete-btn" onclick="deleteFillUp(${fillUp.id})">Delete</button></td>
                `;
            });
        }
        
        function updateDashboard() {
            if (fillUpData.length === 0) {
                document.getElementById('avgMPG').textContent = '--';
                document.getElementById('totalMiles').textContent = '--';
                document.getElementById('totalSpent').textContent = '$--';
                document.getElementById('avgCostPerMile').textContent = '$--';
                document.getElementById('totalFillUps').textContent = '0';
                document.getElementById('avgRange').textContent = '--';
                return;
            }
            
            // Calculate metrics
            const validMPG = fillUpData.filter(f => f.mpg !== null && f.mpg > 0).map(f => f.mpg);
            const avgMPG = validMPG.length > 0 ? validMPG.reduce((a, b) => a + b, 0) / validMPG.length : 0;
            
            const sortedByOdometer = [...fillUpData].sort((a, b) => a.odometer - b.odometer);
            const totalMiles = sortedByOdometer.length > 1 ? 
                sortedByOdometer[sortedByOdometer.length - 1].odometer - sortedByOdometer[0].odometer : 0;
            
            const totalSpent = fillUpData.reduce((sum, f) => sum + f.totalCost, 0);
            
            const validCostPerMile = fillUpData.filter(f => f.costPerMile !== null && f.costPerMile > 0).map(f => f.costPerMile);
            const avgCostPerMile = validCostPerMile.length > 0 ? 
                validCostPerMile.reduce((a, b) => a + b, 0) / validCostPerMile.length : 0;
            
            const validRange = fillUpData.filter(f => f.predictedRange && f.predictedRange > 0).map(f => f.predictedRange);
            const avgRange = validRange.length > 0 ? 
                validRange.reduce((a, b) => a + b, 0) / validRange.length : 0;
            
            // Update dashboard
            document.getElementById('avgMPG').textContent = avgMPG > 0 ? avgMPG.toFixed(1) : '--';
            document.getElementById('totalMiles').textContent = totalMiles > 0 ? totalMiles.toLocaleString() : '--';
            document.getElementById('totalSpent').textContent = '$' + totalSpent.toFixed(2);
            document.getElementById('avgCostPerMile').textContent = avgCostPerMile > 0 ? '$' + avgCostPerMile.toFixed(3) : '--';
            document.getElementById('totalFillUps').textContent = fillUpData.length;
            document.getElementById('avgRange').textContent = avgRange > 0 ? Math.round(avgRange) : '--';
        }
        
        function updateStatistics() {
            if (fillUpData.length === 0) {
                document.getElementById('bestMPG').textContent = '--';
                document.getElementById('bestCostPerMile').textContent = '--';
                document.getElementById('bestRange').textContent = '--';
                document.getElementById('totalGallons').textContent = '--';
                document.getElementById('avgPricePerGallon').textContent = '--';
                document.getElementById('mostUsedOctane').textContent = '--';
                return;
            }
            
            // Best performance
            const validMPG = fillUpData.filter(f => f.mpg !== null && f.mpg > 0);
            const bestMPG = validMPG.length > 0 ? Math.max(...validMPG.map(f => f.mpg)) : 0;
            
            const validCostPerMile = fillUpData.filter(f => f.costPerMile !== null && f.costPerMile > 0);
            const bestCostPerMile = validCostPerMile.length > 0 ? Math.min(...validCostPerMile.map(f => f.costPerMile)) : 0;
            
            const validRange = fillUpData.filter(f => f.predictedRange && f.predictedRange > 0);
            const bestRange = validRange.length > 0 ? Math.max(...validRange.map(f => f.predictedRange)) : 0;
            
            // Fuel details
            const totalGallons = fillUpData.reduce((sum, f) => sum + f.gallons, 0);
            const avgPricePerGallon = fillUpData.reduce((sum, f) => sum + f.pricePerGallon, 0) / fillUpData.length;
            
            // Most used octane
            const octaneCounts = {};
            fillUpData.forEach(f => {
                octaneCounts[f.octaneRating] = (octaneCounts[f.octaneRating] || 0) + 1;
            });
            const mostUsedOctane = Object.keys(octaneCounts).reduce((a, b) => 
                octaneCounts[a] > octaneCounts[b] ? a : b, '');
            
            // Update statistics
            document.getElementById('bestMPG').textContent = bestMPG > 0 ? bestMPG.toFixed(1) : '--';
            document.getElementById('bestCostPerMile').textContent = bestCostPerMile > 0 ? '$' + bestCostPerMile.toFixed(3) : '--';
            document.getElementById('bestRange').textContent = bestRange > 0 ? bestRange + ' mi' : '--';
            document.getElementById('totalGallons').textContent = totalGallons.toFixed(1);
            document.getElementById('avgPricePerGallon').textContent = '$' + avgPricePerGallon.toFixed(3);
            document.getElementById('mostUsedOctane').textContent = mostUsedOctane ? mostUsedOctane + ' octane' : '--';
        }
        
        function clearForm() {
            document.getElementById('fillupDate').valueAsDate = new Date();
            document.getElementById('odometer').value = '';
            document.getElementById('gallons').value = '';
            document.getElementById('totalCost').value = '';
            document.getElementById('octaneRating').value = '';
            document.getElementById('predictedRange').value = '';
            document.getElementById('location').value = '';
            document.getElementById('notes').value = '';
        }
        
        function exportData() {
            if (fillUpData.length === 0) {
                alert('No data to export!');
                return;
            }
            
            const exportData = {
                fillUpData: fillUpData,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `prius-fuel-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAlert('Data exported successfully!', 'success');
        }
        
        function importData() {
            document.getElementById('fileInput').click();
        }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.fillUpData && Array.isArray(importedData.fillUpData)) {
                        if (fillUpData.length > 0) {
                            if (!confirm('This will replace all existing data. Are you sure?')) {
                                return;
                            }
                        }
                        
                        fillUpData = importedData.fillUpData;
                        saveData();
                        updateDisplay();
                        showAlert(`Successfully imported ${fillUpData.length} records!`, 'success');
                    } else {
                        throw new Error('Invalid file format');
                    }
                } catch (error) {
                    alert('Error importing file. Please make sure it\'s a valid Prius Fuel Tracker export file.');
                }
            };
            reader.readAsText(file);
            
            // Reset the file input
            event.target.value = '';
        }
        
        function clearAllData() {
            if (fillUpData.length === 0) {
                alert('No data to clear!');
                return;
            }
            
            if (confirm('Are you sure you want to delete ALL fill-up records? This cannot be undone!')) {
                if (confirm('Really sure? This will permanently delete all your fuel tracking data!')) {
                    fillUpData = [];
                    saveData();
                    updateDisplay();
                    showAlert('All data cleared.', 'info');
                }
            }
        }
        
        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(alert, content.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // Auto-save every 30 seconds as backup
        setInterval(() => {
            if (fillUpData.length > 0) {
                saveData();
            }
        }, 30000);
    </script>
</body>
</html>